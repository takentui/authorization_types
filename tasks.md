Домашнее задание №3  
Тема: «Сессионная авторизация в FastAPI» (ветка с реализованным cookie-based login)

-------------------------------------------------------------------
# TASK-SET: Session Auth Practice

## Task 1 — «Remember me» режим  
• Цель: позволить пользователю выбирать длительную сессию.  
• Шаги:  
  – Расширить `LoginRequest` полем `remember_me: bool = False`.  
  – Если `remember_me`, выставлять `max_age` куки на 7 дней, иначе — 30 минут.  
  – Хранить TTL сессии в памяти (dict) и проверять его при каждом запросе.

## Task 2 — Управление пользователями и хэши паролей  
• Цель: убрать захардкоженные креды, хранить пользователей локально без внешних зависимостей.  
• Шаги:  
  – Создать структуру `users: dict[str, str] = {username: password_hash}`.  
  – Использовать `passlib.hash.sha256_crypt` для генерации и проверки хэшей.  
  – Функция `validate_credentials(username, password)` сверяет хэш.

## Task 3 — Middleware для продления сессии  
• Цель: автоматически продлевать TTL при активности пользователя.  
• Шаги:  
  – `SessionRefreshMiddleware` проверяет, что до истечения < 5 минут.  
  – Если да, продлевает TTL на исходное время (`30 мин` или `7 дней`).  
  – Добавить middleware в `app.main`.

## Task 4 — Безопасные cookie-параметры  
• Цель: production-harden cookies.  
• Шаги:  
  – Читать из `.env`: `COOKIE_SECURE`, `COOKIE_DOMAIN`, `COOKIE_SAMESITE`.  
  – Передавать их в `response.set_cookie`.  
  – Пояснение:  
    • `Secure` – запрещает передачу по HTTP, защищает от Man in the Middle.  
    • `HttpOnly` – защищает от XSS, недоступно JS.  
    • `SameSite` – снижает риск CSRF, ограничивая cross-site-запросы.  
    • `Domain` – ограничивает область действия куки.

## Task 5 — Регистрация пользователя  
• Цель: публичная ручка `/register` добавляет нового пользователя в `users`.  
• Шаги:  
  – `RegisterRequest` со схемой `username`, `password`.  
  – Проверять уникальность имени, хешировать пароль, сохранять в dict.  
  – После регистрации можно авторизоваться обычным `/login`.

## Task 6 — Тестирование  
• Инструменты: `pytest`, `httpx`.  
  – Тесты:  
    1. Успешный логин (корректные куки, 200).  
    2. Неуспешный логин (401).  
    3. `/protected` без куки → 401.  
    4. `/protected` с истекшей сессией → 401.  
    5. Logout очищает сессию.  
    6. Remember-me TTL > 30 минут.  
    7. Middleware продлевает TTL при активности.  
    8. `/registration` регистрация с уже существующим логином
    8. `/registration` успешная регистрация
